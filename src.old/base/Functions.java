/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package base;

import java.io.File;
import javafx.application.Platform;
import javafx.scene.Scene;
import javafx.scene.control.Button;
import javafx.scene.control.Label;
import javafx.scene.layout.HBox;
import javafx.stage.Stage;
import javafx.scene.layout.VBox;
import javax.xml.bind.JAXBContext;
import javax.xml.bind.JAXBException;
import javax.xml.bind.Unmarshaller;
import asycuda.Awmds;
import dao.DbHandler;
import dao.Escale;
import db.BillOfLanding;
import db.BillOfLandingJpaController;
import db.Container;
import db.ContainerJpaController;
import db.EscaleJpaController;
import db.GeneralInfo;
import db.GeneralInfoJpaController;
import db.exceptions.IllegalOrphanException;
import db.exceptions.NonexistentEntityException;
import db.exceptions.PreexistingEntityException;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.math.BigDecimal;
import java.sql.Connection;
import java.sql.Date;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;
import javafx.collections.FXCollections;
import javafx.scene.control.Alert;
import javafx.scene.control.Alert.AlertType;
import javax.persistence.EntityManagerFactory;
import javax.persistence.Persistence;
import javax.xml.bind.Marshaller;
import javax.xml.bind.UnmarshalException;
import manifestservice.ManifestService;
import static manifestservice.ManifestService.LOG;
import static manifestservice.ManifestService.dateFormater;
import properties.Config;

/**
 *
 * @author CALVINO
 */
public class Functions {

    private static Awmds mani;
    private static Awmds man;
    private static GeneralInfo gen;
    private static List<BillOfLanding> bols = new ArrayList<>(), bols2 = new ArrayList<>();
    private static BillOfLanding bl;
    private static List<Container> ctnrs = new ArrayList<>();
    private static Container newctn;
    private static GeneralInfo general;

    private static Label message;
    private static Button yesButton, noButton;
    private static Stage window;
    private static Scene scene;
    static int BolSaved = 0;
    public static referenceTable ref = new referenceTable();
    public static final EntityManagerFactory EMF = Persistence.createEntityManagerFactory("ASYCUDAPU");
    private static final GeneralInfoJpaController GIJC = new GeneralInfoJpaController(EMF);
    private static final BillOfLandingJpaController BOLJC = new BillOfLandingJpaController(EMF);
    private static final ContainerJpaController CTNJC = new ContainerJpaController(EMF);
    private static final EscaleJpaController ESCJC = new EscaleJpaController(EMF);
    private static JAXBContext jc;
    private static Unmarshaller unmarshaller;
    private static Marshaller marshaller;
    public static HashMap<String, List<String>> alerts = new HashMap<String, List<String>>();

    public static final String PRE_MAN_EXP = "Manifest";
    public static final String PRE_MAN_IMP = "Manifest";
    public static String PRE_MAN = "";

    static Connection conn;
    private static int j = 0;

    //transforme a manifest XML file into an object of Awmds in order to using the data in it 
    public static Awmds xmlToAwmds(File xmlFichier) throws JAXBException {
        mani = new Awmds();
        try {
            jc = JAXBContext.newInstance(Awmds.class);
            unmarshaller = jc.createUnmarshaller();
            mani = (Awmds) unmarshaller.unmarshal(xmlFichier);
            return mani;
        } catch (UnmarshalException ue) {
            ue.printStackTrace();
        }
        return mani;
    }

    //Take the instance of Awmds object and save into a xml file in a specific location
    public static void AwmdsToXml(Awmds awmds, File file) {
        try {
            jc = JAXBContext.newInstance(Awmds.class);
            marshaller = jc.createMarshaller();
            marshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, true);

            // Marshalling and saving XML to the file.
            marshaller.marshal(awmds, file);

        } catch (JAXBException e) { // catches ANY exception
            manifestservice.ManifestService.LOG.info("JAXBException error code : " + e.getErrorCode() + " " + e.getMessage());
            e.printStackTrace();
        }
    }

    //import a XML manifest to fill all the fields in order of editing the manifest or checking it out
    public static Awmds selectXml(File xmlFile) throws JAXBException {
        if (xmlFile != null) {
            alerts = new HashMap<>();
            man = xmlToAwmds(xmlFile);
            //                    LOG.info(man.getGeneralSegment().getGeneralSegmentId().getCustomsOfficeCode());
            return man;
        } else {
            manifestservice.ManifestService.LOG.info("Pas xml trouvé ");
            return null;
        }
    }

    public static int persistToDB(Awmds cargo, Escale escale) throws NonexistentEntityException, IllegalOrphanException, PreexistingEntityException, Exception {
        gen = getGeneral(cargo);
        gen.setId(GIJC.findLastId());
        gen.setIdEscale(ESCJC.findEscale(BigDecimal.valueOf(escale.getEscleunik())));
        gen.setNumeroEscale(escale.getNumero());

//        String url = Config.PROPERTIES.getString("mysql.url");
//        String user = Config.PROPERTIES.getString("mysql.user");
//        String password = Config.PROPERTIES.getString("mysql.password");
//        final String ConnectionString = Config.PROPERTIES.getString("mysql.url");
//        try {
//            Class.forName(Config.PROPERTIES.getString("mysql.driver"));
//        } catch (ClassNotFoundException e) {
//            System.err.println(e.getMessage());
//        }
//        try {
//            conn = DriverManager.getConnection(ConnectionString, user, password);
//
//        } catch (SQLException e) {
//            e.printStackTrace();
//            ManifestService.LOG.info(e.getMessage());
//        }
//        String queryString = "select id from general_info where date_departure = ? and voyage_number =?";
//
//        if (conn != null) {
//            try {
//                LOG.info("===> Connexion à la base de donnnée avec succès.");
//                PreparedStatement pst = conn.prepareStatement(queryString);
//                LOG.info("********************************************");
//                LOG.info("Recherche du manifeste " + gen.getIdentityoftransporter()
//                        + " avec date depart : " + gen.getDateDeparture() + " et numero de voyage : " + gen.getVoyageNumber());
//
//                String depart = dateFormater(gen.getDateDeparture()).format(DateTimeFormatter.ISO_DATE);
//                String voy = gen.getVoyageNumber();
//
//                
//
//                pst.setString(1, depart);
//                pst.setString(2, voy);
//                ResultSet rst = pst.executeQuery();
//                if (rst.next()) {
//                    return rst.getInt("id");
//                }
//                LOG.info("********************************************");
//                conn.close();
//
//            } catch (SQLException ex) {
//                LOG.info(ex.getLocalizedMessage());
//            }
//        }
//        if (GIJC.getGeneralInfoCount() != 0) {
//            GIJC.findGeneralInfoEntities().forEach(general -> {
//                if (gen.getVoyageNumber().equals(general.getVoyageNumber())) {
//                    gen.setId(general.getId());
//                    try {
//                        
//                        general.getBillOfLandingCollection().forEach(bol -> {
//                            bol.getContainerCollection().forEach(ctn -> {
//                                try {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      